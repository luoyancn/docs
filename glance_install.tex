\chapter{安装glance}
\label{glance_install}

\section{MySQL配置}

\begin{code-block}{mysql}
CREATE DATABASE glance CHARACTER SET utf8;
GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' IDENTIFIED BY 'glance';
GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' IDENTIFIED BY 'glance';
\end{code-block}

\section{Glance安装配置}
\begin{code-block}{bash}
openstack-config --set /etc/glance/glance-api.conf DEFAULT debug True
openstack-config --set /etc/glance/glance-api.conf DEFAULT workers 2
openstack-config --set /etc/glance/glance-api.conf database connection \
    mysql+pymysql://glance:glance@controller/glance

openstack-config --set /etc/glance/glance-api.conf keystone_authtoken \
    auth_uri http://controller:5000
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken \
    auth_url http://controller:35357
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken \
    auth_type password
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken \
    project_domain_name default
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken \
    user_domain_name default
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken \
    project_name service
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken \
    username glance
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken \
    password glance

openstack-config --set /etc/glance/glance-api.conf paste_deploy flavor keystone

openstack-config --set /etc/glance/glance-registry.conf DEFAULT debug True
openstack-config --set /etc/glance/glance-registry.conf DEFAULT workers 2
openstack-config --set /etc/glance/glance-registry.conf database connection \
    mysql+pymysql://glance:glance@controller/glance

openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken \
    auth_uri http://controller:5000
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken \
    auth_url http://controller:35357
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken \
    auth_type password
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken \
    project_domain_name default
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken \
    user_domain_name default
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken \
    project_name service
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken \
    username glance
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken \
    password glance

openstack-config --set /etc/glance/glance-registry.conf paste_deploy flavor keystone
\end{code-block}

如果需要使用ceph作为glance的后端存储，还需要进行如下的配置
\begin{code-block}{bash}
openstack-config --set /etc/glance/glance-api.conf glance_store default_store rbd
openstack-config --set /etc/glance/glance-api.conf glance_store stores file,http,rbd,cinder
openstack-config --set /etc/glance/glance-api.conf glance_store rbd_store_pool volumes
openstack-config --set /etc/glance/glance-api.conf glance_store rbd_store_user awcloud
openstack-config --set /etc/glance/glance-api.conf glance_store rbd_store_ceph_conf \
    /etc/ceph/ceph.conf
openstack-config --set /etc/glance/glance-api.conf glance_store filesystem_store_datadir \
    /var/lib/glance/images/

openstack-config --set /etc/glance/glance-registry.conf glance_store default_store rbd
openstack-config --set /etc/glance/glance-registry.conf glance_store stores file,http,rbd,cinder
openstack-config --set /etc/glance/glance-registry.conf glance_store rbd_store_pool volumes
openstack-config --set /etc/glance/glance-registry.conf glance_store rbd_store_user awcloud
openstack-config --set /etc/glance/glance-registry.conf glance_store rbd_store_ceph_conf \
    /etc/ceph/ceph.conf
openstack-config --set /etc/glance/glance-registry.conf glance_store \
    filesystem_store_datadir /var/lib/glance/images/
\end{code-block}

初始化glance，并启动
\begin{code-block}{bash}
glance-manage db_sync
chown -R glance:glance /etc/glance/ /var/lib/glance/ /var/log/glance
for id in openstack-glance-{api,registry};do systemctl enable $id;systemctl start $id;done
\end{code-block}
