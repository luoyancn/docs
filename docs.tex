% openany可以去除章节之间的空白页
%\documentclass[b5paper,openany,twoside]{book}
\documentclass[b5paper]{book}
\usepackage{xeCJK}
\usepackage{indentfirst}
\usepackage{fancyhdr}
\usepackage[newfloat]{minted}
\usepackage{float}
\usepackage{pifont}
\usepackage{geometry}
% hyperref之前
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage[utf8]{inputenc}
\usepackage[dvipsnames,table]{xcolor}
\usepackage{caption}
%\usepackage{tabularx}
\usepackage{ltablex}
\usepackage[tikz]{bclogo,rotating}
\usepackage{mdframed}
\usepackage{tikz}
\usepackage{pgf}
\usepackage{enumerate}
\usepackage{outlines}
\usepackage{enumitem}
\usepackage{verbatim}
\usepackage{attachfile2}
% 用于处理过长url
\usepackage{xurl}
\usepackage{charter}
\usepackage{tcolorbox}
\usepackage[explicit]{titlesec}
\usepackage{titletoc}
% 设置minted字体
\usepackage{fontspec}
% 每页的脚注重新编号
\usepackage{perpage}
\MakePerPage{footnote}
% 强制脚注和引用在相同页，需要使用footnote，不能使用footmark

\usetikzlibrary{calc}
\usetikzlibrary{arrows, decorations.pathmorphing,
                backgrounds, positioning, fit, petri, automata}
\tikzset{font=\tiny}
\definecolor{yellow1}{rgb}{1,0.8,0.2}

\DeclareGraphicsRule{.mps}{eps}{.mps}{}

\definecolor{lbcolor}{rgb}{0.9,0.9,0.9}
\usemintedstyle{tango}
% 设置minted字体
\setmonofont{CodeNewRoman Nerd Font Mono}
\hypersetup{%
    bookmarks=true,
    % 设置文档属性的标题
    pdftitle={综合手册},
    % 设置文档属性的作者
    pdfauthor={张家龙},
    pdfborder={0 0 0},
    pdfsubject={OpenStack},
    pdfkeywords={OpenStack, Develop, Federation},
    colorlinks=true,
    linkcolor=black,
    citecolor=green,
    filecolor=green,
    urlcolor=cyan!50!black!90
}

\newcommand\dunderline[3][-1pt]{{%
  \sbox0{#3}%
  \ooalign{\copy0\cr\rule[\dimexpr#1-#2\relax]{\wd0}{#2}}}}

\newcommand{\colorunderlineref}[1]{{\color{RedOrange} \dunderline{1pt}{\nameref{#1}}}}
\newcommand{\colorunderline}[1]{{\color{WildStrawberry} \dunderline{1pt}{#1}}}

% 设置字体
\setmainfont{Times New Roman}
%\setmainfont{CodeNewRoman Nerd Font Mono}
%宋体
%\setCJKmainfont{SimSun}
% 华文新楷
%\setCJKmainfont{STXINGKA.TTF}
%\setCJKmainfont{方正硬笔行书简体.ttf}
\setCJKmainfont{方正北魏楷书简体.ttf}
% 设置页边距
%\geometry{left=2.5cm,right=2.5cm,top=2.4cm,bottom=2.4cm}
% 设置页边距，包括脚注
\geometry{includefoot,top=2.4cm,bottom=2.4cm}
% 修改图注为 图1-1 xxx
% 修改表注为 表1-1 xxx
\renewcommand{\figurename}{图}
\renewcommand{\tablename}{表}
\renewcommand {\thetable} {\thechapter{}-\arabic{table}}
\renewcommand {\thefigure} {\thechapter{}-\arabic{figure}}
% 增加对代码的引用支持，实现类似图表一样的引用链接
\newenvironment{sourcecode}{\captionsetup{type=listing}}{}
% 修改代码引用标记
\SetupFloatingEnvironment{listing}{name=代码段}
% 修改代码的题注和序号
\renewcommand {\thelisting} {\thechapter{}-\arabic{listing}}

% 去除冒号
\captionsetup{labelformat=default,labelsep=space}
% 修改图注和标注的字体大小
\captionsetup{font={small}}

\definecolor{DarkGray}{gray}{0.2}
\definecolor{doc}{RGB}{105,105,105}
\definecolor{mybluei}{RGB}{105,105,105}
\definecolor{myblueii}{RGB}{105,105,105}
\newcommand\ChapterFont{\rmfamily\selectfont\huge}
\newcommand\SectionFont{\bfseries\rmfamily\selectfont\Large}

%~~~~~~~~~~~~~~~~~章设置~~~~~~~~~~~~~~~~~~~~~~
\titleformat{\chapter}[block]
 {\normalfont\ChapterFont\huge\color{myblueii}}%\raisebox{-0.6\height}
 {\tcbset{colframe=mybluei, boxrule=0.8pt, left=0pt, right=0pt, top=0pt, bottom=0pt}\raisebox{-0.48\height}{\rotatebox{90}{\tcbox[boxsep=4pt, colback= white ]{\color{mybluei}\Large\chaptertitlename}}}\hskip 0.25em\mbox{\tcbox[ boxsep=12pt, colback=mybluei, tcbox raise = -35pt]{\color{white}\bfseries\fontsize{70}{70}\selectfont\thechapter}}}
 {0.5em}
 {#1\vskip0.6ex\endgraf\titlerule[1ex]}[]

 \titleformat{name=\chapter,numberless}[block]
 {\normalfont\selectfont\huge\color{myblueii}}
 {}
 {0pt}
 {\parbox[b]{70pt}{\mbox{}}%
 \hspace{15pt}%
 \parbox[b]{\dimexpr\textwidth-15pt}{%
 \raggedright\bfseries#1\vskip6pt%
 }%
 }
 \titleformat{\section}
 {\normalfont\small\sffamily\SectionFont\color{myblueii}}
 {\colorbox{mybluei}{%
        \parbox[c][16pt][c]{40pt}{%
            \centering\textcolor{white}{\SectionFont\Large\rmfamily\thesection}%
        }%
    }%
 }
 {1em}
 {#1}
% [\vspace{-0.755\baselineskip}%
% \color{myblueii}\hspace*{\dimexpr40pt+2\fboxsep\relax}%
% \rule{\dimexpr\textwidth-40pt-2\fboxsep\relax}{1pt}%
% ]

%~~~~~~~~~~~~~~~~~节设置~~~~~~~~~~~~~~~~~~~~~~
%\titleformat{\section}[block]
%  {\normalfont\huge\bfseries}
%  {\tikz\node[
%      font=\huge\bfseries\color{white},
%      fill=gray!50,
%      rounded corners=20pt,
%      minimum height=1.6cm,
%      text width=3em,
%      align=center,
%      inner xsep=0pt] {\parbox{1.5em}{\thesection\hfill}};%
%  }
%  {-1em}
%  {\tikz\node[
%      fill=gray,
%      font=\Large\sffamily\color{white},
%      minimum height=1.6cm,
%      text width=\the\dimexpr\textwidth-40pt-\fboxsep\relax,
%      align=center,inner xsep=0pt] {#1};%
%  }

%\pagestyle{fancy}
%\fancyhf{}
%\fancyhead[RE,LO]{综合手册}
%\fancyhead[LE,RO]{\includegraphics[scale=0.08]{vim.png}}
%\renewcommand{\headrulewidth}{0.5pt}
%\renewcommand{\footrulewidth}{0.5pt}
%\cfoot{\thepage}
%
%% 设置chapter章节页的页眉页脚
%\fancypagestyle{plain}{
%    \fancyhf{}
%    \fancyhead[RE,LO]{综合手册}
%    \fancyhead[LE,RO]{\includegraphics[scale=0.08]{vim.png}}
%    \renewcommand{\headrulewidth}{0.5pt}
%    \renewcommand{\footrulewidth}{0.5pt}
%    \cfoot{\thepage}
%}

% 设置代码段格式。只使用minted，会出现代码过长无法显示，也会出现代码无法分页的情况
% 配合mdframed则不会出现这些问题
% breaklines表示自动换行
\newenvironment{code-block}[1]
 {\VerbatimEnvironment
  \begin{mdframed}[topline=false, bottomline=false, leftline=false,
                   rightline=false, backgroundcolor=lbcolor,
                   userdefinedwidth=\textwidth]
  \begin{minted}[fontsize=\scriptsize,linenos=false,breaklines=true,breakanywhere,breaksymbolleft=,breakanywheresymbolpre=,]{#1}}
 {\end{minted}\end{mdframed}}

\newenvironment{code-in-enumerate}[1]
 {\VerbatimEnvironment
  \par\parshape0 \linewidth\textwidth
  \begin{mdframed}[topline=false, bottomline=false, leftline=false,
                   rightline=false, backgroundcolor=lbcolor,
                   userdefinedwidth=\textwidth]
  \begin{minted}[fontsize=\scriptsize,linenos=false,breaklines=true,breakanywhere,breaksymbolleft=,breakanywheresymbolpre=,]{#1}}
 {\end{minted}\end{mdframed}\par}
%\begin{minted}[fontsize=\scriptsize,linenos=false,breaklines=true,breakanywhere,breaksymbolleft=,breakanywheresymbolpre=,]{#1}}

% 删除minted代码块当中错误代码所引起的红色边框
\AtBeginEnvironment{minted}{\dontdofcolorbox}
\def\dontdofcolorbox{\renewcommand\fcolorbox[4][]{##4}}
% 另一种删除由于错误代码所引起的红色边框，影响范围较大，可用于minted，inputminted，mintedline等
%\renewcommand{\fcolorbox}[4][]{#4}

% 设置警示表格
\newenvironment{warning}
  {\par\begin{mdframed}[linewidth=2pt,linecolor=black]%
    \begin{list}{}{\leftmargin=1cm
                   \labelwidth=\leftmargin}\item[\color{red} \Large\ding{43}]}
  {\end{list}\end{mdframed}\par}

% 设置另外一种警示框模式
\newenvironment{attention}
{\par\medskip\noindent
\begin{tikzpicture}
  \node[inner sep = 0pt] (box) \bgroup
  \begin{minipage}[t]{.99\textwidth}
    \begin{minipage}{.3\textwidth}
    \centering
    \tikz[scale = 5]\node[scale = 3, rotate = 30]{\bclampe};
    \end{minipage}%
    \begin{minipage}{.65\textwidth}
    \surroundwithmdframed{}}
    {\end{minipage}\hfill
  \end{minipage}
  \egroup;
  \draw[black,line width=3pt]
    ( $ (box.north east) + (-5pt,3pt) $ ) -- ( $ (box.north east) + (0,3pt) $ ) -- ( $ (box.south east) + (0,-3pt) $ ) -- + (-5pt,0);
  \draw[black,line width=3pt]
    ( $ (box.north west) + (5pt,3pt) $ ) -- ( $ (box.north west) + (0,3pt) $ ) -- ( $ (box.south west) + (0,-3pt) $ ) -- + (5pt,0);
\end{tikzpicture}
\par\medskip}

\begin{document}

\begin{titlepage}
    \centering{
    {\fontsize{40}{48}\selectfont 综合手册} }\\
    \vspace{\fill}
    \centering{\Large{张家龙}}\\
    \vspace{80mm}
\end{titlepage}

\newpage
% 去除目录前后的空白页
%\let\cleardoublepage\clearpage

\frontmatter
{
  \renewcommand*\contentsname{目录}
  \tableofcontents%
  % 不在目录页显示页眉页脚
  \thispagestyle{empty}
}

% 页码从正文开始计算，不从目录开始
\mainmatter

\part{OpenStack}
\include{mitaka}
\part{Ironic篇}
\include{ironic_introduction}
\include{ironic_install}
\include{ironic_develop}
\include{ironic_architecture}
\include{ironic_images}
\part{容器篇}
\include{docker}
\include{kubernetes}
\include{kubernetes_latest}
\include{kubernetes_usage}
\part{存储篇}
\include{storage}
\include{ceph}
\part{语言类}
\include{c}
\include{gcc}
\include{qt}
\include{golang}
\include{rust}
\part{消息队列}
\include{zmq}
\part{操作系统}
\include{linux}
\include{arm}
\include{network}

\end{document}
